# IPåœ°å€æŸ¥è¯¢ Spring Boot Starter

[![Maven Central](https://img.shields.io/maven-central/v/io.github.kk01001/ip2region-spring-boot-starter.svg?style=flat-square)](https://search.maven.org/artifact/io.github.kk01001/ip2region-spring-boot-starter)
[![License](https://img.shields.io/badge/license-Apache%202.0-blue.svg?style=flat-square)](http://www.apache.org/licenses/LICENSE-2.0.html)

**ä¸€å¥è¯æ¦‚è¿°ï¼š** åŸºäº [ip2region](https://github.com/lionsoul2014/ip2region) çš„ Spring Boot Starterï¼Œæä¾›ä¾¿æ·çš„ IP åœ°å€å½’å±åœ°æŸ¥è¯¢æœåŠ¡ï¼Œæ— éœ€è¿æ¥äº’è”ç½‘ï¼Œæ”¯æŒç¦»çº¿æŸ¥è¯¢ã€‚

## èƒŒæ™¯

åœ¨äº’è”ç½‘åº”ç”¨å¼€å‘ä¸­ï¼Œç»å¸¸éœ€è¦æ ¹æ®ç”¨æˆ·çš„ IP åœ°å€è·å–å…¶æ‰€åœ¨çš„åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œä¾‹å¦‚å›½å®¶ã€çœä»½ã€åŸå¸‚ç­‰ã€‚è¿™äº›ä¿¡æ¯å¯ä»¥ç”¨äºç”¨æˆ·è¡Œä¸ºåˆ†æã€å®‰å…¨å®¡è®¡ã€åœ°åŸŸç»Ÿè®¡ç­‰å¤šç§åœºæ™¯ã€‚

ä¼ ç»Ÿçš„ IP åœ°å€æŸ¥è¯¢æ–¹å¼é€šå¸¸ä¾èµ–åœ¨çº¿ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œå­˜åœ¨æ¥å£è°ƒç”¨é™åˆ¶ã€ç½‘ç»œå»¶è¿Ÿã€æœåŠ¡ä¸ç¨³å®šç­‰é—®é¢˜ã€‚`ip2region-spring-boot-starter` åŸºäº [ip2region](https://github.com/lionsoul2014/ip2region) é¡¹ç›®ï¼Œæä¾›äº†ä¸€ç§ç¦»çº¿æŸ¥è¯¢ IP åœ°å€å½’å±åœ°çš„è§£å†³æ–¹æ¡ˆï¼Œå…·æœ‰æŸ¥è¯¢é€Ÿåº¦å¿«ã€æ— ç½‘ç»œä¾èµ–ã€å¯é æ€§é«˜ç­‰ä¼˜ç‚¹ã€‚

## é¡¹ç›®ç›®æ ‡

- **ä¾¿æ·é›†æˆ**ï¼šä¸ Spring Boot æ— ç¼é›†æˆï¼Œç®€å•é…ç½®å³å¯ä½¿ç”¨
- **é«˜æ€§èƒ½**ï¼šåŸºäº xdb å¼•æ“ï¼Œæä¾›æ¯«ç§’çº§çš„æŸ¥è¯¢æ€§èƒ½
- **ç¦»çº¿æŸ¥è¯¢**ï¼šæ— éœ€è¿æ¥äº’è”ç½‘ï¼Œæ”¯æŒæœ¬åœ°æ•°æ®åº“æŸ¥è¯¢
- **ä½å†…å­˜æ¶ˆè€—**ï¼šé‡‡ç”¨å†…å­˜æ˜ å°„æŠ€æœ¯ï¼Œå‡å°‘å†…å­˜å ç”¨
- **æ•°æ®ç²¾ç¡®**ï¼šåŸºäº ip2region é¡¹ç›®çš„é«˜è´¨é‡ IP æ•°æ®åº“

## æ ¸å¿ƒåŠŸèƒ½ä¸äº®ç‚¹ âœ¨

- **è‡ªåŠ¨é…ç½®**ï¼šSpring Boot è‡ªåŠ¨é…ç½®ï¼Œå¼€ç®±å³ç”¨
- **ç®€æ´ API**ï¼šæä¾›ç®€å•æ˜“ç”¨çš„æŸ¥è¯¢æ¥å£
- **æ•°æ®å‡†ç¡®**ï¼šè¿”å›å›½å®¶ã€åœ°åŒºã€çœä»½ã€åŸå¸‚ã€ISP ç­‰å®Œæ•´ä¿¡æ¯
- **æ€§èƒ½ä¼˜è¶Š**ï¼šåŸºäºä¼˜åŒ–çš„ xdb å¼•æ“ï¼ŒæŸ¥è¯¢æ€§èƒ½é«˜
- **å¼‚å¸¸å¤„ç†**ï¼šå†…ç½®å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œæé«˜ç³»ç»Ÿç¨³å®šæ€§

## æŠ€æœ¯æ ˆ ğŸ› ï¸

- Java 21
- Spring Boot 3.x
- ip2region 2.7.0

## å¿«é€Ÿå¼€å§‹ ğŸš€

### æ·»åŠ ä¾èµ–

```xml
<dependency>
    <groupId>io.github.kk01001</groupId>
    <artifactId>ip2region-spring-boot-starter</artifactId>
    <version>${latest.version}</version>
</dependency>
```

### é…ç½®å±æ€§

åœ¨ `application.yml` æˆ– `application.properties` ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```yaml
ip2region:
  # æ˜¯å¦å¯ç”¨IPåœ°å€æŸ¥è¯¢åŠŸèƒ½
  enabled: true
  # IPæ•°æ®åº“æ–‡ä»¶è·¯å¾„ï¼ˆå¿…é¡»é…ç½®ï¼‰
  db-path: /path/to/your/ip2region.xdb
```

> æ³¨æ„ï¼šä½ éœ€è¦ä¸‹è½½ ip2region æ•°æ®åº“æ–‡ä»¶ã€‚å¯ä»¥ä» [ip2region å®˜æ–¹ä»“åº“](https://github.com/lionsoul2014/ip2region/tree/master/data) è·å– `ip2region.xdb` æ–‡ä»¶ã€‚

### ä½¿ç”¨ç¤ºä¾‹

```java
/**
 * @author kk01001
 * @date 2025-02-13 14:31:00
 * @description IPåœ°å€æŸ¥è¯¢æœåŠ¡
 */
@Service
@RequiredArgsConstructor
public class IpLocationService {

    private final Ip2RegionTemplate ip2RegionTemplate;
    
    /**
     * æŸ¥è¯¢IPåœ°å€å½’å±åœ°
     */
    public RegionResult queryIpLocation(String ip) {
        return ip2RegionTemplate.search(ip);
    }
    
    /**
     * è·å–ç”¨æˆ·IPæ‰€åœ¨åŸå¸‚
     */
    public String getUserCity(HttpServletRequest request) {
        String ip = getClientIp(request);
        RegionResult result = ip2RegionTemplate.search(ip);
        if (result != null) {
            return result.getProvince() + " " + result.getCity();
        }
        return "æœªçŸ¥";
    }
    
    /**
     * è·å–å®¢æˆ·ç«¯çœŸå®IPåœ°å€
     */
    private String getClientIp(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("Proxy-Client-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("WL-Proxy-Client-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        // å¤šçº§ä»£ç†çš„æƒ…å†µï¼Œç¬¬ä¸€ä¸ªIPä¸ºå®¢æˆ·ç«¯çœŸå®IP
        if (ip != null && ip.contains(",")) {
            ip = ip.split(",")[0].trim();
        }
        return ip;
    }
}
```

### åœ¨Controllerä¸­ä½¿ç”¨

```java
/**
 * @author kk01001
 * @date 2025-02-13 14:31:00
 * @description IPåœ°å€æŸ¥è¯¢æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/ip")
@RequiredArgsConstructor
public class IpController {

    private final Ip2RegionTemplate ip2RegionTemplate;
    
    /**
     * æŸ¥è¯¢IPå½’å±åœ°
     */
    @GetMapping("/query")
    public Result<RegionResult> queryIp(@RequestParam String ip) {
        RegionResult result = ip2RegionTemplate.search(ip);
        if (result != null) {
            return Result.success(result);
        }
        return Result.error("IPåœ°å€æŸ¥è¯¢å¤±è´¥");
    }
    
    /**
     * è·å–å½“å‰ç”¨æˆ·çš„IPå½’å±åœ°
     */
    @GetMapping("/current")
    public Result<RegionResult> getCurrentUserIpInfo(HttpServletRequest request) {
        String ip = getClientIp(request);
        RegionResult result = ip2RegionTemplate.search(ip);
        if (result != null) {
            return Result.success(result);
        }
        return Result.error("IPåœ°å€æŸ¥è¯¢å¤±è´¥");
    }
    
    // getClientIpæ–¹æ³•å®ç°åŒä¸Š...
}
```

## è¿”å›æ•°æ®ç»“æ„

`RegionResult` åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
| --- | --- | --- | --- |
| country | String | å›½å®¶ | ä¸­å›½ |
| area | String | åœ°åŒº | åä¸œ |
| province | String | çœä»½ | æµ™æ±Ÿçœ |
| city | String | åŸå¸‚ | æ­å·å¸‚ |
| isp | String | ç½‘ç»œè¿è¥å•† | ç”µä¿¡ |

ç¤ºä¾‹è¿”å›å€¼ï¼š

```json
{
  "country": "ä¸­å›½",
  "area": "åä¸œ",
  "province": "æµ™æ±Ÿçœ",
  "city": "æ­å·å¸‚",
  "isp": "ç”µä¿¡"
}
```

## é«˜çº§ç”¨æ³•

### 1. ä½¿ç”¨AOPæ‹¦æˆªå™¨è‡ªåŠ¨è®°å½•IPå½’å±åœ°

```java
/**
 * @author kk01001
 * @date 2025-02-13 14:31:00
 * @description IPå½’å±åœ°è®°å½•åˆ‡é¢
 */
@Aspect
@Component
@RequiredArgsConstructor
public class IpLogAspect {

    private final Ip2RegionTemplate ip2RegionTemplate;
    private final HttpServletRequest request;
    
    @Around("@annotation(org.springframework.web.bind.annotation.RequestMapping)")
    public Object around(ProceedingJoinPoint joinPoint) throws Throwable {
        String ip = getClientIp(request);
        RegionResult region = ip2RegionTemplate.search(ip);
        
        // è®°å½•è¯·æ±‚ä¿¡æ¯å’ŒIPå½’å±åœ°
        MDC.put("clientIp", ip);
        if (region != null) {
            MDC.put("ipLocation", region.getProvince() + "-" + region.getCity());
        }
        
        try {
            return joinPoint.proceed();
        } finally {
            MDC.remove("clientIp");
            MDC.remove("ipLocation");
        }
    }
    
    // getClientIpæ–¹æ³•å®ç°åŒä¸Š...
}
```

### 2. è‡ªå®šä¹‰å¤„ç†ä¸åŒåœ°åŸŸçš„ç”¨æˆ·

```java
/**
 * @author kk01001
 * @date 2025-02-13 14:31:00
 * @description åœ°åŸŸå¤„ç†æœåŠ¡
 */
@Service
@RequiredArgsConstructor
public class RegionService {

    private final Ip2RegionTemplate ip2RegionTemplate;
    
    /**
     * æ ¹æ®ç”¨æˆ·IPåˆ¤æ–­æ˜¯å¦å¢ƒå¤–ç”¨æˆ·
     */
    public boolean isOverseasUser(String ip) {
        RegionResult region = ip2RegionTemplate.search(ip);
        if (region != null) {
            return !"ä¸­å›½".equals(region.getCountry());
        }
        return false;
    }
    
    /**
     * æ ¹æ®ç”¨æˆ·IPè·å–é€‚åˆçš„æœåŠ¡å™¨èŠ‚ç‚¹
     */
    public String getProperServerNode(String ip) {
        RegionResult region = ip2RegionTemplate.search(ip);
        if (region == null) {
            return "default-node";
        }
        
        // æ ¹æ®åœ°åŸŸä¿¡æ¯é€‰æ‹©æœ€è¿‘çš„æœåŠ¡èŠ‚ç‚¹
        switch (region.getArea()) {
            case "åä¸œ":
                return "east-china-node";
            case "åå—":
                return "south-china-node";
            case "ååŒ—":
                return "north-china-node";
            default:
                return "central-node";
        }
    }
}
```

### 3. ä¸Gatewayé›†æˆå®ç°åœ°åŸŸè·¯ç”±

```java
/**
 * @author kk01001
 * @date 2025-02-13 14:31:00
 * @description åŸºäºIPåœ°åŸŸçš„è·¯ç”±è¿‡æ»¤å™¨
 */
@Component
@RequiredArgsConstructor
public class IpBasedRouteFilter implements GlobalFilter, Ordered {

    private final Ip2RegionTemplate ip2RegionTemplate;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String ip = getClientIp(exchange.getRequest());
        RegionResult region = ip2RegionTemplate.search(ip);
        
        if (region != null) {
            // æ·»åŠ åœ°åŸŸä¿¡æ¯åˆ°è¯·æ±‚å¤´
            ServerHttpRequest request = exchange.getRequest().mutate()
                .header("X-User-Country", region.getCountry())
                .header("X-User-Province", region.getProvince())
                .header("X-User-City", region.getCity())
                .build();
                
            // æ›´æ–°è·¯ç”±ä¿¡æ¯
            return chain.filter(exchange.mutate().request(request).build());
        }
        
        return chain.filter(exchange);
    }
    
    @Override
    public int getOrder() {
        return Ordered.HIGHEST_PRECEDENCE + 100;
    }
    
    // getClientIpæ–¹æ³•å®ç°...
}
```

## æ€§èƒ½ä¼˜åŒ–

ip2region ä½¿ç”¨çš„ xdb å¼•æ“å·²ç»åšäº†è®¸å¤šæ€§èƒ½ä¼˜åŒ–ï¼Œä½†ä»æœ‰ä¸€äº›æœ€ä½³å®è·µå¯ä»¥è¿›ä¸€æ­¥æå‡æ€§èƒ½ï¼š

1. **å†…å­˜æ˜ å°„**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œip2region å·²ä½¿ç”¨å†…å­˜æ˜ å°„ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

2. **ç¼“å­˜çƒ­ç‚¹IP**ï¼šå¯¹äºé¢‘ç¹æŸ¥è¯¢çš„IPï¼Œå¯ä»¥å®ç°äºŒçº§ç¼“å­˜

```java
/**
 * @author kk01001
 * @date 2025-02-13 14:31:00
 * @description å¸¦ç¼“å­˜çš„IPæŸ¥è¯¢æœåŠ¡
 */
@Service
public class CachedIpService {

    private final Ip2RegionTemplate ip2RegionTemplate;
    private final LoadingCache<String, RegionResult> ipCache;
    
    public CachedIpService(Ip2RegionTemplate ip2RegionTemplate) {
        this.ip2RegionTemplate = ip2RegionTemplate;
        
        // åˆ›å»ºGuavaç¼“å­˜
        this.ipCache = CacheBuilder.newBuilder()
            .maximumSize(10000)  // æœ€å¤šç¼“å­˜10000ä¸ªIP
            .expireAfterWrite(1, TimeUnit.DAYS)  // 1å¤©åè¿‡æœŸ
            .build(new CacheLoader<>() {
                @Override
                public RegionResult load(String ip) {
                    return ip2RegionTemplate.search(ip);
                }
            });
    }
    
    public RegionResult queryIp(String ip) {
        try {
            return ipCache.get(ip);
        } catch (ExecutionException e) {
            return ip2RegionTemplate.search(ip);
        }
    }
}
```

## åº”ç”¨åœºæ™¯

- **ç”¨æˆ·è¡Œä¸ºåˆ†æ**ï¼šæ ¹æ®ç”¨æˆ·IPæ‰€å±åœ°åŒºåˆ†æç”¨æˆ·è¡Œä¸ºç‰¹å¾
- **è¥é”€æ´»åŠ¨å®šå‘**ï¼šé’ˆå¯¹ç‰¹å®šåœ°åŸŸç”¨æˆ·æä¾›å®šåˆ¶åŒ–çš„è¥é”€æ´»åŠ¨
- **å†…å®¹åˆ†å‘ä¼˜åŒ–**ï¼šæ ¹æ®ç”¨æˆ·åœ°ç†ä½ç½®é€‰æ‹©æœ€è¿‘çš„CDNèŠ‚ç‚¹
- **å®‰å…¨é£æ§**ï¼šè¯†åˆ«å¼‚å¸¸ç™»å½•åœ°ç‚¹ï¼Œæé«˜è´¦å·å®‰å…¨æ€§
- **è®¿é—®æ§åˆ¶**ï¼šé™åˆ¶ç‰¹å®šåœ°åŒºç”¨æˆ·çš„è®¿é—®æƒé™
- **æ•°æ®åˆè§„**ï¼šæ»¡è¶³ä¸åŒåœ°åŒºæ•°æ®ä¿æŠ¤æ³•è§„çš„åˆè§„è¦æ±‚
- **æ—¥å¿—åˆ†æ**ï¼šåœ¨ç³»ç»Ÿæ—¥å¿—ä¸­è®°å½•ç”¨æˆ·IPå½’å±åœ°ä¿¡æ¯ï¼Œä¾¿äºåç»­åˆ†æ

## å¸¸è§é—®é¢˜

### 1. å¦‚ä½•æ›´æ–°IPæ•°æ®åº“ï¼Ÿ

ip2region æ•°æ®åº“æ–‡ä»¶éœ€è¦å®šæœŸæ›´æ–°ä»¥ä¿æŒå‡†ç¡®æ€§ã€‚æ›´æ–°æ—¶ï¼Œåªéœ€æ›¿æ¢é…ç½®çš„æ•°æ®åº“æ–‡ä»¶è·¯å¾„æŒ‡å‘çš„æ–‡ä»¶å³å¯ã€‚å¦‚æœå¸Œæœ›åŠ¨æ€æ›´æ–°è€Œä¸é‡å¯åº”ç”¨ï¼Œå¯ä»¥å®ç°ä»¥ä¸‹æ–¹æ¡ˆï¼š

```java
/**
 * @author kk01001
 * @date 2025-02-13 14:31:00
 * @description IPæ•°æ®åº“æ›´æ–°æœåŠ¡
 */
@Service
@RequiredArgsConstructor
public class Ip2RegionUpdater {

    private final Ip2RegionProperties properties;
    
    /**
     * æ›´æ–°IPæ•°æ®åº“
     */
    @Scheduled(cron = "0 0 3 1 * ?")  // æ¯æœˆ1æ—¥å‡Œæ™¨3ç‚¹æ‰§è¡Œ
    public void updateDatabase() throws Exception {
        String dbPath = properties.getDbPath();
        String backupPath = dbPath + ".bak";
        String newDbPath = dbPath + ".new";
        
        // ä¸‹è½½æ–°æ•°æ®åº“æ–‡ä»¶
        downloadLatestDatabase(newDbPath);
        
        // å¤‡ä»½æ—§æ–‡ä»¶
        Files.copy(Paths.get(dbPath), Paths.get(backupPath), StandardCopyOption.REPLACE_EXISTING);
        
        // æ›¿æ¢æ•°æ®åº“æ–‡ä»¶
        Files.move(Paths.get(newDbPath), Paths.get(dbPath), StandardCopyOption.REPLACE_EXISTING);
        
        // é‡æ–°åŠ è½½Searcher
        reloadSearcher();
    }
    
    private void downloadLatestDatabase(String savePath) {
        // å®ç°ä¸‹è½½é€»è¾‘
    }
    
    private void reloadSearcher() {
        // é‡æ–°åŠ è½½æœç´¢å™¨
    }
}
```

### 2. IP2Region æ•°æ®åº“çš„å‡†ç¡®æ€§å¦‚ä½•ï¼Ÿ

ip2region çš„æ•°æ®åº“å‡†ç¡®æ€§ç›¸å¯¹è¾ƒé«˜ï¼Œä½†ç”±äº IP åœ°å€åˆ†é…å’Œç½‘ç»œæ‹“æ‰‘ç»“æ„çš„å˜åŒ–ï¼Œå¯èƒ½å­˜åœ¨ä¸€å®šè¯¯å·®ã€‚å¯¹äºéœ€è¦é«˜ç²¾åº¦å®šä½çš„åœºæ™¯ï¼Œå»ºè®®ç»“åˆå¤šç§æ•°æ®æºè¿›è¡Œäº¤å‰éªŒè¯ã€‚

### 3. ç§æœ‰ç½‘ç»œå’Œå†…ç½‘IPå¦‚ä½•å¤„ç†ï¼Ÿ

å¯¹äºç§æœ‰ç½‘ç»œIPï¼ˆå¦‚192.168.x.xã€10.x.x.xç­‰ï¼‰ï¼Œip2region ä¼šè¿”å›å†…ç½‘åœ°å€ç›¸å…³ä¿¡æ¯ã€‚åœ¨ä¸šåŠ¡ä¸­åº”æ³¨æ„è¿™ç±»IPçš„ç‰¹æ®Šå¤„ç†ï¼š

```java
/**
 * @author kk01001
 * @date 2025-02-13 14:31:00
 * @description IPå¤„ç†å·¥å…·ç±»
 */
public class IpUtils {

    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºå†…ç½‘IP
     */
    public static boolean isInternalIp(String ip) {
        if (ip == null || ip.isEmpty()) {
            return true;
        }
        
        try {
            byte[] addr = InetAddress.getByName(ip).getAddress();
            return isInternalIp(addr);
        } catch (Exception e) {
            return false;
        }
    }
    
    private static boolean isInternalIp(byte[] addr) {
        if (addr.length != 4) {
            return false;
        }
        
        // 10.x.x.x
        if (addr[0] == 10) {
            return true;
        }
        
        // 172.16.x.x - 172.31.x.x
        if (addr[0] == (byte) 172 && (addr[1] >= 16 && addr[1] <= 31)) {
            return true;
        }
        
        // 192.168.x.x
        return addr[0] == (byte) 192 && addr[1] == (byte) 168;
    }
}
```

## è´¡çŒ® ğŸ™

æ¬¢è¿æäº¤Issueæˆ–Pull Requestå‚ä¸é¡¹ç›®è´¡çŒ®ï¼

## è®¸å¯è¯

æœ¬é¡¹ç›®ä½¿ç”¨ [Apache License 2.0](http://www.apache.org/licenses/LICENSE-2.0.html) è®¸å¯è¯ã€‚

## è‡´è°¢

æœ¬é¡¹ç›®åŸºäº [ip2region](https://github.com/lionsoul2014/ip2region) å¼€å‘ï¼Œæ„Ÿè°¢ ip2region é¡¹ç›®å›¢é˜Ÿæä¾›çš„ä¼˜ç§€å·¥ä½œã€‚ 